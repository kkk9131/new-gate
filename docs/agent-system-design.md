# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±
- **ä½œæˆæ—¥**: 2025-11-09
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
- **å¯¾è±¡**: AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ 
- **ç›®çš„**: ã‚¿ã‚¹ã‚¯ã®è‡ªå‹•åŒ–ã¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã®è¨­è¨ˆ

---

## ğŸ¯ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¯ã€**ç¹°ã‚Šè¿”ã—ä½œæ¥­ã®è‡ªå‹•åŒ–**ã¨**è¤‡æ•°ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ¨ªæ–­ã—ãŸã‚¿ã‚¹ã‚¯å®Ÿè¡Œ**ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

### ã‚³ã‚¢ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

```yaml
è‡ªå‹•åŒ–:
  - å®šæœŸå®Ÿè¡Œï¼ˆcronå½¢å¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
  - ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼å®Ÿè¡Œ
  - æ‰‹å‹•å®Ÿè¡Œ

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:
  - è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®é€£é–å®Ÿè¡Œ
  - æ¡ä»¶åˆ†å²ãƒ»ãƒ«ãƒ¼ãƒ—
  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒªãƒˆãƒ©ã‚¤

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³é€£æº:
  - è¤‡æ•°ãƒ—ãƒ©ã‚°ã‚¤ãƒ³APIå‘¼ã³å‡ºã—
  - ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã—
  - çµæœé›†ç´„
```

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Task Scheduler (Cron Engine)     â”‚
â”‚  - å®šæœŸå®Ÿè¡Œç®¡ç†                      â”‚
â”‚  - ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Workflow Executor Engine          â”‚
â”‚  - YAML/JSONè§£æ                     â”‚
â”‚  - ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ                      â”‚
â”‚  - æ¡ä»¶åˆ†å²å‡¦ç†                      â”‚
â”‚  - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Plugin API Caller               â”‚
â”‚  - ãƒ—ãƒ©ã‚°ã‚¤ãƒ³APIå‘¼ã³å‡ºã—             â”‚
â”‚  - Core APIå‘¼ã³å‡ºã—                  â”‚
â”‚  - ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Task History Storage           â”‚
â”‚  - å®Ÿè¡Œãƒ­ã‚°ä¿å­˜                      â”‚
â”‚  - æˆåŠŸ/å¤±æ•—è¨˜éŒ²                     â”‚
â”‚  - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ ã‚¿ã‚¹ã‚¯å®šç¾©

### YAMLå½¢å¼

```yaml
# task-definition.yaml
name: "æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ"
description: "æ¯æœˆ1æ—¥ã«å…ˆæœˆã®å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡"

schedule:
  cron: "0 9 1 * *"  # æ¯æœˆ1æ—¥ 9:00
  timezone: "Asia/Tokyo"

workflow:
  steps:
    - id: "fetch-revenues"
      action: "plugin.call"
      plugin: "com.platform.revenue"
      method: "getRevenues"
      params:
        startDate: "{{ lastMonth.start }}"
        endDate: "{{ lastMonth.end }}"
      output: "revenues"

    - id: "aggregate-data"
      action: "transform"
      input: "{{ revenues }}"
      transform: "sum"
      field: "amount"
      output: "total"

    - id: "generate-pdf"
      action: "plugin.call"
      plugin: "com.platform.pdf-generator"
      method: "createReport"
      params:
        template: "monthly-revenue"
        data:
          total: "{{ total }}"
          revenues: "{{ revenues }}"
      output: "pdfUrl"

    - id: "send-email"
      action: "plugin.call"
      plugin: "com.platform.email"
      method: "send"
      params:
        to: "manager@example.com"
        subject: "æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ"
        body: "å…ˆæœˆã®å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆã‚’æ·»ä»˜ã—ã¾ã™"
        attachments:
          - "{{ pdfUrl }}"

    - id: "notify-completion"
      action: "ui.notification"
      params:
        message: "æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ"
        type: "success"

  onError:
    - action: "ui.notification"
      params:
        message: "ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {{ error.message }}"
        type: "error"

    - action: "plugin.call"
      plugin: "com.platform.logger"
      method: "logError"
      params:
        error: "{{ error }}"
```

### JSONå½¢å¼

```json
{
  "name": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ",
  "description": "æœŸé™ãŒ3æ—¥ä»¥å†…ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é€šçŸ¥",
  "schedule": {
    "cron": "0 18 * * *",
    "timezone": "Asia/Tokyo"
  },
  "workflow": {
    "steps": [
      {
        "id": "fetch-projects",
        "action": "plugin.call",
        "plugin": "com.platform.projects",
        "method": "getActiveProjects",
        "output": "projects"
      },
      {
        "id": "filter-due-soon",
        "action": "filter",
        "input": "{{ projects }}",
        "condition": "item.dueDate <= Date.now() + 3 * 24 * 60 * 60 * 1000",
        "output": "dueSoonProjects"
      },
      {
        "id": "send-slack-alert",
        "action": "plugin.call",
        "plugin": "com.platform.slack",
        "method": "postMessage",
        "params": {
          "channel": "#alerts",
          "text": "æœŸé™ãŒè¿‘ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: {{ dueSoonProjects.length }}ä»¶"
        },
        "condition": "dueSoonProjects.length > 0"
      }
    ]
  }
}
```

---

## âš™ï¸ å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³

### Workflow Executor

```typescript
class WorkflowExecutor {
  async execute(workflow: Workflow, context: ExecutionContext) {
    const results = new Map<string, any>();

    for (const step of workflow.steps) {
      try {
        // æ¡ä»¶ãƒã‚§ãƒƒã‚¯
        if (step.condition && !this.evaluateCondition(step.condition, results)) {
          continue;
        }

        // ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ
        const result = await this.executeStep(step, results, context);

        // çµæœä¿å­˜
        if (step.output) {
          results.set(step.output, result);
        }

        // ãƒ­ã‚°è¨˜éŒ²
        await this.logStepSuccess(step.id, result);

      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        await this.logStepError(step.id, error);

        if (workflow.onError) {
          await this.executeErrorHandler(workflow.onError, error);
        }

        // ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
        if (step.retry) {
          await this.retryStep(step, results, context);
        } else {
          throw error;
        }
      }
    }

    return results;
  }

  private async executeStep(
    step: WorkflowStep,
    results: Map<string, any>,
    context: ExecutionContext
  ) {
    switch (step.action) {
      case 'plugin.call':
        return await this.callPluginAPI(step, results);

      case 'transform':
        return await this.transformData(step, results);

      case 'filter':
        return await this.filterData(step, results);

      case 'ui.notification':
        return await this.showNotification(step, results);

      default:
        throw new Error(`Unknown action: ${step.action}`);
    }
  }

  private async callPluginAPI(step: PluginCallStep, results: Map<string, any>) {
    const plugin = await this.loadPlugin(step.plugin);
    const params = this.resolveVariables(step.params, results);

    return await plugin[step.method](params);
  }

  private resolveVariables(template: any, results: Map<string, any>): any {
    // {{ variable }} ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
    const json = JSON.stringify(template);
    const resolved = json.replace(/\{\{\s*(\w+(?:\.\w+)*)\s*\}\}/g, (_, path) => {
      return this.getNestedValue(results, path);
    });
    return JSON.parse(resolved);
  }
}
```

---

## ğŸ•’ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼

### Cronå½¢å¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```typescript
class TaskScheduler {
  private scheduler: CronScheduler;
  private tasks: Map<string, ScheduledTask> = new Map();

  async scheduleTask(taskId: string, cronExpression: string, workflow: Workflow) {
    const job = this.scheduler.schedule(cronExpression, async () => {
      await this.executeTask(taskId, workflow);
    });

    this.tasks.set(taskId, {
      id: taskId,
      cron: cronExpression,
      workflow,
      job,
      lastRun: null,
      nextRun: job.nextDate(),
    });
  }

  async executeTask(taskId: string, workflow: Workflow) {
    const execution = await this.createExecution(taskId);

    try {
      const executor = new WorkflowExecutor();
      const results = await executor.execute(workflow, {
        executionId: execution.id,
      });

      await this.markExecutionSuccess(execution.id, results);
    } catch (error) {
      await this.markExecutionFailure(execution.id, error);
    }
  }

  cancelTask(taskId: string) {
    const task = this.tasks.get(taskId);
    if (task) {
      task.job.cancel();
      this.tasks.delete(taskId);
    }
  }
}
```

---

## ğŸ“Š å®Ÿè¡Œå±¥æ­´ç®¡ç†

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

```sql
-- ã‚¿ã‚¹ã‚¯å®šç¾©
CREATE TABLE agent_tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),

  name VARCHAR(255) NOT NULL,
  description TEXT,

  workflow JSONB NOT NULL,
  schedule JSONB,  -- { cron, timezone }

  is_active BOOLEAN DEFAULT TRUE,

  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- å®Ÿè¡Œå±¥æ­´
CREATE TABLE agent_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES agent_tasks(id) ON DELETE CASCADE,

  status VARCHAR(20) NOT NULL,  -- running, success, failed
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMPTZ,

  results JSONB,
  error_message TEXT,

  execution_time_ms INT
);

-- ã‚¹ãƒ†ãƒƒãƒ—ãƒ­ã‚°
CREATE TABLE agent_step_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  execution_id UUID NOT NULL REFERENCES agent_executions(id) ON DELETE CASCADE,

  step_id VARCHAR(255) NOT NULL,
  status VARCHAR(20) NOT NULL,

  input JSONB,
  output JSONB,
  error_message TEXT,

  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  execution_time_ms INT
);
```

---

## ğŸ¨ UIè¨­è¨ˆ

### ã‚¿ã‚¹ã‚¯ä¸€è¦§ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¹ã‚¯                [+ æ–°è¦ä½œæˆ] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ã‚¢ã‚¯ãƒ†ã‚£ãƒ–] [åœæ­¢ä¸­] [ã™ã¹ã¦]                â”‚
â”‚                                                â”‚
â”‚  âœ… æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ                   â”‚
â”‚     æ¯æœˆ1æ—¥ 9:00 | æœ€çµ‚å®Ÿè¡Œ: 2025-11-01        â”‚
â”‚     [ç·¨é›†] [å®Ÿè¡Œ] [åœæ­¢]                       â”‚
â”‚                                                â”‚
â”‚  âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé™ã‚¢ãƒ©ãƒ¼ãƒˆ                   â”‚
â”‚     æ¯æ—¥ 18:00 | æœ€çµ‚å®Ÿè¡Œ: 2025-11-08          â”‚
â”‚     [ç·¨é›†] [å®Ÿè¡Œ] [åœæ­¢]                       â”‚
â”‚                                                â”‚
â”‚  â¸ï¸ ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—                         â”‚
â”‚     æ¯é€±æ—¥æ›œ 2:00 | åœæ­¢ä¸­                     â”‚
â”‚     [ç·¨é›†] [é–‹å§‹]                              â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Ÿè¡Œå±¥æ­´ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®Ÿè¡Œå±¥æ­´ - æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… 2025-11-01 09:00  æˆåŠŸ  å®Ÿè¡Œæ™‚é–“: 3.2s    â”‚
â”‚  âœ… 2025-10-01 09:00  æˆåŠŸ  å®Ÿè¡Œæ™‚é–“: 2.8s    â”‚
â”‚  âŒ 2025-09-01 09:00  å¤±æ•—  ã‚¨ãƒ©ãƒ¼: API timeoutâ”‚
â”‚  âœ… 2025-08-01 09:00  æˆåŠŸ  å®Ÿè¡Œæ™‚é–“: 3.1s    â”‚
â”‚                                                â”‚
â”‚  [è©³ç´°ã‚’è¡¨ç¤º]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ APIä»•æ§˜

```typescript
// ã‚¿ã‚¹ã‚¯ä½œæˆ
POST /api/agents/tasks
{
  "name": "ã‚¿ã‚¹ã‚¯å",
  "workflow": { ... },
  "schedule": { "cron": "0 9 * * *" }
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§å–å¾—
GET /api/agents/tasks

// ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
POST /api/agents/tasks/:taskId/execute

// ã‚¿ã‚¹ã‚¯åœæ­¢
POST /api/agents/tasks/:taskId/pause

// å®Ÿè¡Œå±¥æ­´å–å¾—
GET /api/agents/tasks/:taskId/executions

// ãƒ­ã‚°å–å¾—
GET /api/agents/executions/:executionId/logs
```

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¦ä»¶å®šç¾©](./platform-requirements.md)
- [ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](./plugin-architecture.md)
- [Core APIä»•æ§˜](./core-api-spec.md)
- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ](./database-schema.md)
