# マルチエージェントチャット要件定義書

## 📋 ドキュメント情報
- **作成日**: 2025-11-15
- **バージョン**: 0.1
- **対象**: マルチエージェント対応チャットUI（最大4画面）
- **目的**: エージェント作成フローと同時タスク実行の要求事項整理

---

## 🎯 目的と背景
デスクトップ風SaaS内で、ユーザーが自然言語チャットを通じてエージェントに業務指示を出し、必要なアプリを自動操作してもらう。既に最大4面の同時操作が可能な基盤を活かし、タスクごとの可視化・安全制御・モデル切替を明確化する。

---

## 🧑‍💻 主要ユースケース
- チャットUIでタスクを自然言語指示し、最大4つの作業を並列実行。
- モバイルからタスクを投げ、進行状況はSaaS内4分割画面でライブ確認。
- 破壊的操作（削除・複製など）はチャット上のYes/Noで承認してから実行。
- タスク結果と録画を後から見返し、LLMモデルも都度選択して再実行。

---

## 🧩 機能要件

### 1. チャット入力とエージェント起動
- **自然言語操作**: 現状はテキスト入力。将来的に音声入力を追加できるUI拡張ポイントを確保。
- **起動トグル**: チャットUI内に「×1〜×4」のエージェント起動トグルを配置。選択した数だけ画面（ワークスペース）を生成し、それぞれが独立したタスクを受け持つ。
- **タスク割当**: タスクは指定画面にバインドされ、画面クローズまでは履歴と状態を保持。

### 2. 進捗表示とストリーミング
- **WebRTC配信**: 各画面はWebRTCでエージェントの実操作を低遅延表示。入力イベントと表示を同期し、ユーザーは常時プレビュー可能。
- **履歴維持**: タスク完了後も画面状態を維持し、ユーザーが任意タイミングでログ再生・確認できる。

### 3. タスク管理とログ
- **ログ単位**: タスクごとにチャット履歴・操作ログ・WebRTC録画URLを紐付け保存。
- **保持期間**: 既定30日保存＋保存時暗号化（サーバー側鍵管理）。ユーザーが30日/90日/無期限を選べる設定を準備し、長期はコールドストレージへ退避。
- **失敗時の挙動**: エラー発生時にチャットへ詳細を提示し、「再試行」「中断」から選択できるUIを用意。

### 4. モデル・キー管理
- **APIキー登録**: ユーザーが複数LLMのAPIキーを登録・保管。安全に暗号化保存し、タスク起動時に利用キーを選択。
- **モデル切替**: Cursorのようにタスク別でモデルを選択可能。推論中でも違う画面では別モデルを走らせられるよう独立したセッション管理を行う。

### 5. 安全・承認フロー
- **設定系操作の禁止**: エージェントはアプリ設定やシステム構成を変更できないロールに固定。
- **破壊的操作**: 削除・複製などは必ずチャットUI上でYes/Noの確認を挟み、ユーザー承認がなければ実行しない。
- **権限制御**: テンプレ権限（閲覧専用/編集可 etc）をベースに、タスク単位でカスタム微調整できるUIを提供。

### 6. 通知・連携
- **アプリ内通知**: 既存のアプリ内通知システムと連動し、タスク開始/完了/承認待ちを即時表示。
- **将来拡張**: モバイルからタスクを投げた際にSlack通知を送れるようにする。Webhook設計を先行しておき、今後の追加に備える。

### 7. モバイル対応
- **指示入力**: モバイルUIからもタスク投入が可能。レスポンシブなチャットUIを前提としたAPIを共用。
- **閲覧**: モバイルでは映像フル表示が難しいため、要約ビュー＋必要時にWebRTCストリームへ遷移できる設計を検討。

---

## 🔐 認証・権限モデル
- 既存の認証（例: JWT/SSO）を継続利用し、エージェントタスク用のロール/スコープを追加。既存の監査・SSOフローとの互換性を維持。
- 各タスクには「許可テンプレ＋カスタム設定」をアタッチし、許可されたアプリ/APIのみ操作可能にする。
- 承認履歴（誰がYes/Noしたか）をログとして残し、後から追跡できるようにする。

---

## 🗄️ データ & セキュリティ要件
- **暗号化**: APIキーとタスクログは保存時暗号化。キーはフェデレーテッドKMSで管理し、実行時のみ復号。
- **監査ログ**: 画面配信と操作イベントはタイムスタンプ付きで保存。30日経過後は自動アーカイブまたはユーザー設定に従って削除。
- **アクセス監視**: 4画面中どの画面がどの権限で動いたかを可視化できるダッシュボード（MVPではメトリクス出力まで）。

---

## ⚙️ 技術スタック検討ポイント
- WebRTC SFUまたは既存配信基盤を採用し、4ストリーム同時配信でも遅延・負荷を抑える。
- 各画面は独立した仮想ワークスペース（ブラウザ or ネイティブアプリ制御）を持ち、タスクごとにセッションID・モデルIDを割り当てる。
- チャット→タスク連携はイベント駆動（例: `task.create`）で実装し、状態管理はZustand/Supabaseを併用。

---

## 🚨 エラー & リカバリ
- **自動リカバリ**: 軽微なネットワーク切断は自動再接続し、ユーザーにはバナー通知。
- **ユーザー選択**: 致命的エラー時にはチャットに詳細を提示し、「再試行 / 中断」のボタンで明示的に選ばせる。
- **ログ出力**: エラーコードとスタックはサーバーログ＋タスク履歴に格納し、サポートチームが確認可能。

---

## 🔮 将来拡張メモ
- **音声入力**: 音声 → テキスト変換モジュールを追加し、ハンズフリー操作を実現。
- **Slack通知**: モバイル起点タスクの作成/完了をSlackへpushできるWebhookコネクタを開発。
- **タスクテンプレ**: 反復指示のテンプレ化＋自然言語追記によるハイブリッド運用をサポート。

---

## ✅ 次ステップ
1. 本要件をベースにUI要件定義（画面遷移・コンポーネント構成）を策定。
2. WebRTC配信方式（SFU/VMC etc）のPoC実施と負荷見積り。
3. モデル/APIキー管理画面の情報設計とセキュアストレージ選定。

